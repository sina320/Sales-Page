<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourBin ¬∑ Sales Commander</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #F5F7FA;
            padding: 28px;
            color: #1E293B;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
        }

        /* ===== ÿ±ŸÜ⁄Ø‚ÄåŸáÿß€å ÿ≥ÿßÿ≤ŸÖÿßŸÜ€å TourBin ===== */
        :root {
            --tb-primary: #1E4A6F;      /* ÿ¢ÿ®€å ÿ™€åÿ±Ÿá ÿßÿµŸÑ€å */
            --tb-primary-light: #2E6A95;
            --tb-primary-soft: #E8F0F7;
            --tb-secondary: #E67E22;     /* ŸÜÿßÿ±ŸÜÿ¨€å */
            --tb-secondary-light: #FEF2E7;
            --tb-success: #27AE60;
            --tb-success-light: #E8F5E9;
            --tb-warning: #F39C12;
            --tb-warning-light: #FEF5E7;
            --tb-danger: #E74C3C;
            --tb-danger-light: #FDEDEC;
            --tb-gray-100: #F8FAFC;
            --tb-gray-200: #F1F5F9;
            --tb-gray-300: #E2E8F0;
            --tb-gray-400: #CBD5E1;
            --tb-gray-500: #94A3B8;
            --tb-gray-600: #64748B;
            --tb-gray-700: #475569;
            --tb-gray-800: #334155;
            --tb-gray-900: #1E293B;
            --tb-white: #FFFFFF;
            --tb-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --tb-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* ===== HEADER ÿ®ÿß ŸÑŸà⁄ØŸà€å ÿ±ÿ≥ŸÖ€å ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            background: var(--tb-white);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: var(--tb-shadow);
            border: 1px solid var(--tb-gray-200);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .logo-fallback {
            font-size: 24px;
            font-weight: 700;
            color: var(--tb-primary);
            display: none;
        }

        .brand-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            background: var(--tb-primary-soft);
            border-radius: 40px;
            color: var(--tb-primary);
            font-size: 14px;
            font-weight: 600;
            border: 1px solid var(--tb-primary-light);
        }

        .brand-badge i {
            color: var(--tb-primary);
        }

        /* ===== ÿ™ŸÇŸà€åŸÖ ÿ®ÿß ÿ±ŸÜ⁄Ø‚ÄåŸáÿß€å ÿ≥ÿßÿ≤ŸÖÿßŸÜ€å ===== */
        .calendar-section {
            background: var(--tb-white);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 28px;
            border: 1px solid var(--tb-gray-200);
            box-shadow: var(--tb-shadow);
        }

        .calendar-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .date-range-picker {
            display: flex;
            align-items: center;
            background: var(--tb-white);
            border: 1.5px solid var(--tb-gray-300);
            border-radius: 40px;
            padding: 4px;
            cursor: pointer;
            min-width: 360px;
            transition: all 0.2s;
        }

        .date-range-picker:hover {
            border-color: var(--tb-primary);
        }

        .date-range-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 24px;
            background: var(--tb-white);
            border-radius: 40px;
            font-size: 14px;
            font-weight: 500;
            color: var(--tb-gray-800);
        }

        .date-range-display i {
            color: var(--tb-primary);
            font-size: 16px;
        }

        .apply-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 28px;
            background: var(--tb-primary);
            border: none;
            border-radius: 40px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--tb-primary);
        }

        .apply-btn:hover {
            background: var(--tb-primary-light);
            transform: translateY(-1px);
            box-shadow: var(--tb-shadow);
        }

        .apply-btn i {
            font-size: 14px;
        }

        .quick-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 8px 20px;
            background: var(--tb-gray-100);
            border-radius: 40px;
            font-size: 13px;
            font-weight: 500;
            color: var(--tb-gray-700);
            cursor: pointer;
            border: 1.5px solid var(--tb-gray-200);
            transition: all 0.2s;
        }

        .tag:hover {
            background: var(--tb-primary-soft);
            border-color: var(--tb-primary);
            color: var(--tb-primary);
        }

        .tag.active {
            background: var(--tb-primary);
            border-color: var(--tb-primary);
            color: white;
        }

        /* ===== KPI Cards ===== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .kpi-card {
            background: var(--tb-white);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--tb-gray-200);
            box-shadow: var(--tb-shadow);
            transition: all 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--tb-shadow-lg);
            border-color: var(--tb-primary-light);
        }

        .kpi-label {
            font-size: 12px;
            color: var(--tb-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-label i { 
            color: var(--tb-primary); 
            font-size: 14px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--tb-gray-900);
            margin-bottom: 8px;
        }

        .kpi-trend { 
            font-size: 12px; 
            color: var(--tb-gray-600);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .trend-up { 
            color: var(--tb-success);
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .trend-down { 
            color: var(--tb-danger);
            display: flex;
            align-items: center;
            gap: 2px;
        }

        /* ===== Section Styles ===== */
        .section {
            background: var(--tb-white);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 28px;
            border: 1px solid var(--tb-gray-200);
            box-shadow: var(--tb-shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--tb-gray-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i { 
            color: var(--tb-primary);
            font-size: 20px;
        }

        .badge {
            padding: 6px 14px;
            background: var(--tb-primary-soft);
            color: var(--tb-primary);
            border-radius: 40px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--tb-primary-light);
        }

        .badge-warning { 
            background: var(--tb-warning-light); 
            color: var(--tb-warning);
            border-color: var(--tb-warning);
        }
        
        .badge-agent { 
            background: var(--tb-primary-soft); 
            color: var(--tb-primary);
            border-color: var(--tb-primary-light);
        }
        
        .badge-ota { 
            background: var(--tb-secondary-light); 
            color: var(--tb-secondary);
            border-color: var(--tb-secondary);
        }

        /* ===== Table Styles ===== */
        .table-container {
            overflow-x: auto;
            margin-bottom: 16px;
            border-radius: 12px;
        }

        .table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px;
        }
        
        .table th {
            text-align: left;
            padding: 16px 12px;
            color: var(--tb-gray-600);
            font-weight: 600;
            font-size: 13px;
            border-bottom: 2px solid var(--tb-gray-200);
            background: var(--tb-gray-100);
        }
        
        .table td { 
            padding: 16px 12px; 
            font-size: 14px; 
            border-bottom: 1px solid var(--tb-gray-200);
            color: var(--tb-gray-800);
        }

        .table tbody tr:hover {
            background: var(--tb-gray-100);
        }

        .rank {
            font-weight: 700;
            width: 50px;
            font-size: 16px;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        /* ===== Grid Layouts ===== */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        /* ===== Cash Flow Cards ===== */
        .cash-flow-card {
            background: var(--tb-gray-100);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--tb-gray-200);
        }

        .cash-flow-label {
            color: var(--tb-gray-600);
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cash-flow-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .cash-flow-value.warning { color: var(--tb-warning); }
        .cash-flow-value.danger { color: var(--tb-danger); }
        .cash-flow-value.success { color: var(--tb-success); }

        .cash-flow-sub {
            font-size: 13px;
            color: var(--tb-gray-600);
        }

        /* ===== Loading Overlay ===== */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(4px);
        }

        .loader-content {
            background: var(--tb-white);
            padding: 30px 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--tb-shadow-lg);
            border: 1px solid var(--tb-gray-200);
        }

        .loader-content i {
            font-size: 40px;
            color: var(--tb-primary);
            margin-bottom: 15px;
        }

        .loader-content p {
            color: var(--tb-gray-700);
            font-weight: 500;
        }

        /* ===== Error Message ===== */
        .error-message {
            background: var(--tb-danger-light);
            color: var(--tb-danger);
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-right: 4px solid var(--tb-danger);
            border: 1px solid var(--tb-danger);
        }

        /* ===== Footer ===== */
        .footer {
            margin-top: 28px;
            text-align: center;
            font-size: 13px;
            color: var(--tb-gray-500);
            padding-top: 24px;
            border-top: 1px solid var(--tb-gray-200);
        }

        /* ===== Responsive ===== */
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .grid-3, .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body { padding: 16px; }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-range-picker {
                width: 100%;
                min-width: auto;
            }
            
            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="loader-content">
            <i class="fas fa-spinner fa-spin"></i>
            <p>ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿßÿ∑ŸÑÿßÿπÿßÿ™...</p>
        </div>
    </div>

    <div class="container">
        <!-- ===== HEADER ÿ®ÿß ŸÑŸà⁄ØŸà€å TourBin ===== -->
        <div class="header">
            <div class="logo">
                <!-- TourBin Official Logo -->
                <img src="https://irp.cdn-website.com/4c7fac7a/dms3rep/multi/tourbin.png" 
                     alt="TourBin" 
                     class="logo-image"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="logo-fallback">TourBin</span>
            </div>
            <div class="brand-badge">
                <i class="fas fa-chart-line"></i>
                <span>Sales Commander ¬∑ Real-time Dashboard</span>
            </div>
        </div>

        <!-- ===== CALENDAR SECTION ÿ®ÿß ÿ±ŸÜ⁄Ø‚ÄåŸáÿß€å ÿ≥ÿßÿ≤ŸÖÿßŸÜ€å ===== -->
        <div class="calendar-section">
            <div class="calendar-wrapper">
                <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                    <div class="date-range-picker" id="dateRangePicker">
                        <div class="date-range-display">
                            <i class="fas fa-calendar-alt"></i>
                            <span id="dateRangeText">Select Date Range</span>
                        </div>
                    </div>
                    <button class="apply-btn" id="applyDateBtn">
                        <i class="fas fa-check"></i> Apply
                    </button>
                </div>
                <div class="quick-tags">
                    <button class="tag" onclick="setDateRange('today')">Today</button>
                    <button class="tag" onclick="setDateRange('7days')">7 Days</button>
                    <button class="tag" onclick="setDateRange('30days')">30 Days</button>
                    <button class="tag" onclick="setDateRange('90days')">90 Days</button>
                    <button class="tag" onclick="setDateRange('120days')">120 Days</button>
                    <button class="tag" onclick="setDateRange('360days')">360 Days</button>
                </div>
            </div>
        </div>

        <!-- ===== KPI GRID ===== -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-dollar-sign"></i> Total Sales</div>
                <div class="kpi-value" id="totalSales">$0</div>
                <div class="kpi-trend">
                    <span class="trend-up"><i class="fas fa-arrow-up"></i> CONFIRMED + ARRIVED</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-users"></i> Passengers</div>
                <div class="kpi-value" id="totalPassengers">0</div>
                <div class="kpi-trend">total pax</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-chart-line"></i> Avg per Tour</div>
                <div class="kpi-value" id="avgPerTour">$0</div>
                <div class="kpi-trend" id="transactionsCount">0 transactions</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-percent"></i> Commission</div>
                <div class="kpi-value" id="commission">$0</div>
                <div class="kpi-trend">10% of sales</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-hand-holding-usd"></i> Net Profit</div>
                <div class="kpi-value" id="netProfit">$0</div>
                <div class="kpi-trend" id="profitMargin">margin 0%</div>
            </div>
        </div>

        <!-- ===== TOP PERFORMERS GRID ===== -->
        <div class="grid-3">
            <!-- TOP AGENTS -->
            <div class="section" style="margin-bottom: 0;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-user-tie"></i> Top Agents
                    </div>
                    <span class="badge-agent badge">10% Commission</span>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Agent</th>
                                <th>Sales</th>
                                <th>Commission</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTable">
                            <tr><td colspan="4" style="text-align: center; padding: 30px;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TOP OTAS -->
            <div class="section" style="margin-bottom: 0;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-globe"></i> Top OTAs
                    </div>
                    <span class="badge-ota badge">Net after commission</span>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>OTA</th>
                                <th>Gross</th>
                                <th>Net</th>
                                <th>Share</th>
                            </tr>
                        </thead>
                        <tbody id="otasTable">
                            <tr><td colspan="5" style="text-align: center; padding: 30px;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TOP TOURS -->
            <div class="section" style="margin-bottom: 0;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-umbrella-beach"></i> Top Tours
                    </div>
                    <span class="badge">By Revenue</span>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Tour</th>
                                <th>Bookings</th>
                                <th>Revenue</th>
                                <th>Channel</th>
                            </tr>
                        </thead>
                        <tbody id="toursTable">
                            <tr><td colspan="5" style="text-align: center; padding: 30px;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ===== CASH FLOW ===== -->
        <div class="grid-2">
            <!-- CASH FLOW -->
            <div class="section" style="margin-bottom: 0;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-money-bill-wave"></i> Cash Flow
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div class="cash-flow-card">
                        <div class="cash-flow-label">
                            <i class="fas fa-clock"></i> Unconfirmed
                        </div>
                        <div class="cash-flow-value warning" id="unconfirmedValue">0</div>
                        <div class="cash-flow-sub" id="unconfirmedAmount">$0</div>
                    </div>
                    <div class="cash-flow-card">
                        <div class="cash-flow-label">
                            <i class="fas fa-hourglass-half"></i> Pending
                        </div>
                        <div class="cash-flow-value danger" id="pendingValue">$0</div>
                        <div class="cash-flow-sub" id="pendingCount">0 customers</div>
                    </div>
                    <div class="cash-flow-card">
                        <div class="cash-flow-label">
                            <i class="fas fa-hand-holding-heart"></i> Payables
                        </div>
                        <div class="cash-flow-value success" id="payablesValue">$0</div>
                        <div class="cash-flow-sub" id="payablesDate">Due in 7 days</div>
                    </div>
                </div>
            </div>

            <!-- LAST CALL (ÿ®ÿ±ÿß€å ÿ®ÿπÿØ) -->
            <div class="section" style="margin-bottom: 0;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-clock"></i> Last Call
                    </div>
                    <span class="badge-warning badge">‚è≥ Under 72h</span>
                </div>
                <div id="lastCallContainer" style="min-height: 150px; display: flex; align-items: center; justify-content: center; color: var(--tb-gray-500);">
                    <i class="fas fa-hourglass-half" style="margin-right: 8px;"></i> Coming soon...
                </div>
            </div>
        </div>

        <!-- ===== FOOTER ===== -->
        <div class="footer">
            <i class="fas fa-chart-line"></i> TourBin ¬∑ Sales Commander ¬∑ Real-time Dashboard
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBbxZctdClpD2d8GgRw2DcSrLx7hPXVcH4",
            authDomain: "tourbin-dashboard.firebaseapp.com",
            projectId: "tourbin-dashboard",
            storageBucket: "tourbin-dashboard.appspot.com",
            messagingSenderId: "1033548972731",
            appId: "1:1033548972731:web:5e6a6d6f8d8b8a8b8c8d8e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let user = null;
        let currentStartDate = new Date(new Date().setDate(new Date().getDate() - 7));
        let currentEndDate = new Date();
        let allTransactions = [];

        // Valid statuses for sales calculation
        const VALID_STATUSES = ['CONFIRMED', 'ARRIVED'];

        // OTA commission rates
        const OTA_COMMISSION = {
            'OTA_GetYourGuide': 0.30,
            'OTA_Viator': 0.25,
            'default': 0.25
        };

        // Initialize authentication
        async function initAuth() {
            try {
                await auth.signInAnonymously();
                console.log('‚úÖ Authenticated anonymously');
            } catch (e) {
                console.error('‚ùå Auth failed:', e);
                showError('Authentication failed. Please refresh the page.');
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            document.querySelector('.calendar-section').after(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Format currency
        function formatCurrency(value) {
            return '$' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // Get rank emoji
        function getRankEmoji(index) {
            switch(index) {
                case 0: return 'ü•á';
                case 1: return 'ü•à';
                case 2: return 'ü•â';
                default: return (index + 1) + '';
            }
        }

        // Calendar setup
        const fp = flatpickr("#dateRangePicker", {
            mode: "range",
            dateFormat: "Y-m-d",
            defaultDate: [currentStartDate, currentEndDate],
            onChange: function(selectedDates) {
                if (selectedDates.length === 2) {
                    currentStartDate = selectedDates[0];
                    currentEndDate = selectedDates[1];
                    updateDateDisplay();
                }
            }
        });

        function updateDateDisplay() {
            document.getElementById('dateRangeText').innerHTML = 
                formatDate(currentStartDate) + ' ‚Äî ' + formatDate(currentEndDate);
        }

        // Set date range from quick tags
        window.setDateRange = function(range) {
            const tags = document.querySelectorAll('.tag');
            tags.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const now = new Date();
            
            switch(range) {
                case 'today':
                    currentStartDate = new Date(now);
                    currentEndDate = new Date(now);
                    break;
                case '7days':
                    currentStartDate = new Date(now.setDate(now.getDate() - 7));
                    currentEndDate = new Date();
                    break;
                case '30days':
                    currentStartDate = new Date(now.setDate(now.getDate() - 30));
                    currentEndDate = new Date();
                    break;
                case '90days':
                    currentStartDate = new Date(now.setDate(now.getDate() - 90));
                    currentEndDate = new Date();
                    break;
                case '120days':
                    currentStartDate = new Date(now.setDate(now.getDate() - 120));
                    currentEndDate = new Date();
                    break;
                case '360days':
                    currentStartDate = new Date(now.setDate(now.getDate() - 360));
                    currentEndDate = new Date();
                    break;
            }
            
            fp.setDate([currentStartDate, currentEndDate]);
            updateDateDisplay();
            loadData();
        };

        // Load data from Firestore
        async function loadData() {
            if (!user) return;
            
            document.getElementById('loader').style.display = 'flex';

            try {
                // Fetch all transactions with valid statuses
                const snapshot = await db.collection('sales_transactions')
                    .where('status', 'in', VALID_STATUSES)
                    .get();

                allTransactions = [];
                snapshot.forEach(doc => {
                    allTransactions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`‚úÖ Loaded ${allTransactions.length} transactions`);

                // Filter by date range
                const filteredTransactions = filterByDate(allTransactions);
                
                // Update all UI components
                updateKPIs(filteredTransactions);
                updateAgentsTable(filteredTransactions);
                updateOTAsTable(filteredTransactions);
                updateToursTable(filteredTransactions);
                updateCashFlow(filteredTransactions);

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                showError('Failed to load data: ' + error.message);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Filter transactions by date
        function filterByDate(transactions) {
            const start = new Date(currentStartDate);
            start.setHours(0, 0, 0, 0);
            
            const end = new Date(currentEndDate);
            end.setHours(23, 59, 59, 999);

            return transactions.filter(t => {
                if (!t.creation_date) return false;
                
                const tDate = t.creation_date.toDate ? 
                    t.creation_date.toDate() : 
                    new Date(t.creation_date);
                
                return tDate >= start && tDate <= end;
            });
        }

        // Update KPI cards
        function updateKPIs(transactions) {
            // Total Sales
            const totalSales = transactions.reduce((sum, t) => sum + (t.total_price_usd || 0), 0);
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            
            // Total Passengers
            const totalPassengers = transactions.reduce((sum, t) => sum + (t.total_pax || 0), 0);
            document.getElementById('totalPassengers').textContent = totalPassengers.toLocaleString();
            
            // Average per Tour
            const avgPerTour = transactions.length > 0 ? totalSales / transactions.length : 0;
            document.getElementById('avgPerTour').textContent = formatCurrency(avgPerTour);
            document.getElementById('transactionsCount').textContent = transactions.length + ' transactions';
            
            // Commission (10%)
            const commission = totalSales * 0.1;
            document.getElementById('commission').textContent = formatCurrency(commission);
            
            // Net Profit (after commissions)
            let totalCommission = commission; // Agent commission
            let otaCommission = 0;
            
            transactions.forEach(t => {
                if (t.channel && t.channel.startsWith('OTA_')) {
                    const rate = OTA_COMMISSION[t.channel] || OTA_COMMISSION.default;
                    otaCommission += (t.total_price_usd || 0) * rate;
                }
            });
            
            const netProfit = totalSales - totalCommission - otaCommission;
            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
            
            const margin = totalSales > 0 ? (netProfit / totalSales) * 100 : 0;
            document.getElementById('profitMargin').textContent = `margin ${margin.toFixed(1)}%`;
        }

        // Update Agents table
        function updateAgentsTable(transactions) {
            const agentSales = {};
            
            transactions.forEach(t => {
                const agent = t.agent_name || 'Direct';
                if (!agentSales[agent]) {
                    agentSales[agent] = { sales: 0, count: 0 };
                }
                agentSales[agent].sales += t.total_price_usd || 0;
                agentSales[agent].count++;
            });

            const sortedAgents = Object.entries(agentSales)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);

            const tbody = document.getElementById('agentsTable');
            tbody.innerHTML = '';

            if (sortedAgents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;">No data available</td></tr>';
                return;
            }

            sortedAgents.forEach((agent, index) => {
                const row = document.createElement('tr');
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                
                row.innerHTML = `
                    <td class="rank ${rankClass}">${getRankEmoji(index)}</td>
                    <td>${agent.name}</td>
                    <td>${formatCurrency(agent.sales)}</td>
                    <td>${formatCurrency(agent.sales * 0.1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update OTAs table
        function updateOTAsTable(transactions) {
            const otaSales = {};
            let totalOTASales = 0;

            transactions.forEach(t => {
                if (t.channel && t.channel.startsWith('OTA_')) {
                    if (!otaSales[t.channel]) {
                        otaSales[t.channel] = { gross: 0, count: 0 };
                    }
                    otaSales[t.channel].gross += t.total_price_usd || 0;
                    otaSales[t.channel].count++;
                    totalOTASales += t.total_price_usd || 0;
                }
            });

            const sortedOTAs = Object.entries(otaSales)
                .map(([name, data]) => {
                    const rate = OTA_COMMISSION[name] || OTA_COMMISSION.default;
                    return {
                        name: name.replace('OTA_', ''),
                        gross: data.gross,
                        net: data.gross * (1 - rate),
                        count: data.count,
                        share: totalOTASales > 0 ? (data.gross / totalOTASales) * 100 : 0
                    };
                })
                .sort((a, b) => b.gross - a.gross);

            const tbody = document.getElementById('otasTable');
            tbody.innerHTML = '';

            if (sortedOTAs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No data available</td></tr>';
                return;
            }

            sortedOTAs.forEach((ota, index) => {
                const row = document.createElement('tr');
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                
                row.innerHTML = `
                    <td class="rank ${rankClass}">${getRankEmoji(index)}</td>
                    <td>${ota.name}</td>
                    <td>${formatCurrency(ota.gross)}</td>
                    <td>${formatCurrency(ota.net)}</td>
                    <td>${ota.share.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update Tours table
        function updateToursTable(transactions) {
            const tourSales = {};

            transactions.forEach(t => {
                const tour = t.product_title || 'Unknown Tour';
                if (!tourSales[tour]) {
                    tourSales[tour] = {
                        revenue: 0,
                        bookings: 0,
                        channels: {}
                    };
                }
                tourSales[tour].revenue += t.total_price_usd || 0;
                tourSales[tour].bookings++;
                if (t.channel) {
                    tourSales[tour].channels[t.channel] = (tourSales[tour].channels[t.channel] || 0) + 1;
                }
            });

            const sortedTours = Object.entries(tourSales)
                .map(([name, data]) => {
                    // Find main channel
                    let mainChannel = 'OTA';
                    let maxCount = 0;
                    for (const [channel, count] of Object.entries(data.channels)) {
                        if (count > maxCount) {
                            maxCount = count;
                            mainChannel = channel.startsWith('OTA_') ? channel.replace('OTA_', '') : channel;
                        }
                    }

                    return {
                        name: name.length > 35 ? name.substring(0, 35) + '...' : name,
                        revenue: data.revenue,
                        bookings: data.bookings,
                        mainChannel
                    };
                })
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);

            const tbody = document.getElementById('toursTable');
            tbody.innerHTML = '';

            if (sortedTours.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No data available</td></tr>';
                return;
            }

            sortedTours.forEach((tour, index) => {
                const row = document.createElement('tr');
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                
                row.innerHTML = `
                    <td class="rank ${rankClass}">${getRankEmoji(index)}</td>
                    <td>${tour.name}</td>
                    <td>${tour.bookings}</td>
                    <td>${formatCurrency(tour.revenue)}</td>
                    <td><span class="badge-ota badge">${tour.mainChannel}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update Cash Flow
        function updateCashFlow(transactions) {
            const unconfirmed = allTransactions.filter(t => t.status === 'RESERVED' || t.status === 'PENDING');
            const pending = allTransactions.filter(t => t.status === 'CONFIRMED' && !t.payment_status);
            
            document.getElementById('unconfirmedValue').textContent = unconfirmed.length;
            document.getElementById('unconfirmedAmount').textContent = formatCurrency(
                unconfirmed.reduce((sum, t) => sum + (t.total_price_usd || 0), 0)
            );
            
            const pendingAmount = pending.reduce((sum, t) => sum + (t.total_price_usd || 0), 0);
            document.getElementById('pendingValue').textContent = formatCurrency(pendingAmount);
            document.getElementById('pendingCount').textContent = pending.length + ' customers';
            
            // Agent payables (10% of confirmed sales in last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentConfirmed = allTransactions.filter(t => {
                if (!t.creation_date) return false;
                const tDate = t.creation_date.toDate ? t.creation_date.toDate() : new Date(t.creation_date);
                return t.status === 'CONFIRMED' && tDate >= thirtyDaysAgo;
            });
            
            const payables = recentConfirmed.reduce((sum, t) => sum + (t.total_price_usd || 0), 0) * 0.1;
            document.getElementById('payablesValue').textContent = formatCurrency(payables);
        }

        // Event listeners
        document.getElementById('applyDateBtn').addEventListener('click', loadData);

        // Initialize app
        auth.onAuthStateChanged((u) => {
            user = u;
            if (u) {
                console.log('‚úÖ User authenticated:', u.uid);
                loadData();
            }
        });

        initAuth();
        updateDateDisplay();
    </script>
</body>
</html>
