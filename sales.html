<!-- sales.html -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourBin | ØµÙØ­Ù‡ ÙØ±ÙˆØ´</title>
    
    <!-- ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ Ùˆ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fa.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Ù‡Ø¯Ø± Ùˆ Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† */
        .navbar {
            background: white;
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: #764ba2;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: #555;
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Ø¨Ø®Ø´ ØªØ§Ø±ÛŒØ® */
        .date-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .date-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .date-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-field {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .date-field input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        .date-field input:focus {
            border-color: #764ba2;
            outline: none;
        }

        .date-field i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #764ba2;
        }

        .quick-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tag:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .apply-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .apply-btn:hover {
            transform: translateY(-2px);
        }

        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ KPI */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .kpi-title {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .kpi-sub {
            color: #999;
            font-size: 13px;
        }

        /* Ø¬Ø¯Ø§ÙˆÙ„ ØªØ­Ù„ÛŒÙ„ÛŒ */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .table-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: right;
            padding: 12px 10px;
            background: #f8f9fa;
            color: #555;
            font-weight: 600;
            font-size: 13px;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            color: #444;
        }

        .rank {
            font-weight: 700;
            width: 40px;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-ota { background: #e3f2fd; color: #1976d2; }
        .badge-agent { background: #f3e5f5; color: #7b1fa2; }
        .badge-direct { background: #e8f5e8; color: #2e7d32; }

        /* Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
        }

        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
        }

        /* Ø®Ø·Ø§ */
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 1024px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .date-inputs {
                flex-direction: column;
            }
            
            .date-field {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† -->
        <div class="navbar">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                TourBin Sales Commander
            </div>
            <div class="nav-links">
                <a href="index.html"><i class="fas fa-home"></i> ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
                <a href="sales.html" class="active"><i class="fas fa-chart-bar"></i> ÙØ±ÙˆØ´</a>
                <a href="upload.html"><i class="fas fa-upload"></i> Ø¢Ù¾Ù„ÙˆØ¯</a>
                <a href="payroll.html"><i class="fas fa-wallet"></i> Ø­Ù‚ÙˆÙ‚</a>
                <a href="reports.html"><i class="fas fa-file-alt"></i> Ú¯Ø²Ø§Ø±Ø´Ø§Øª</a>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ ØªØ§Ø±ÛŒØ® -->
        <div class="date-section">
            <div class="date-header">
                <span class="date-title">
                    <i class="fas fa-calendar-alt" style="margin-left: 8px;"></i>
                    Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ú¯Ø²Ø§Ø±Ø´
                </span>
            </div>
            <div class="date-inputs">
                <div class="date-field">
                    <i class="fas fa-calendar"></i>
                    <input type="text" id="startDate" placeholder="ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹">
                </div>
                <div class="date-field">
                    <i class="fas fa-calendar"></i>
                    <input type="text" id="endDate" placeholder="ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†">
                </div>
                <div class="quick-tags">
                    <span class="tag" onclick="setDateRange('today')">Ø§Ù…Ø±ÙˆØ²</span>
                    <span class="tag" onclick="setDateRange('7days')">Û· Ø±ÙˆØ²</span>
                    <span class="tag" onclick="setDateRange('30days')">Û³Û° Ø±ÙˆØ²</span>
                    <span class="tag" onclick="setDateRange('thisMonth')">Ø§ÛŒÙ† Ù…Ø§Ù‡</span>
                    <span class="tag" onclick="setDateRange('lastMonth')">Ù…Ø§Ù‡ Ù‚Ø¨Ù„</span>
                </div>
                <button class="apply-btn" onclick="loadData()">
                    <i class="fas fa-check"></i> Ø§Ø¹Ù…Ø§Ù„
                </button>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ KPI -->
        <div class="kpi-grid" id="kpiCards">
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">ÙØ±ÙˆØ´ Ú©Ù„</span>
                    <div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div>
                </div>
                <div class="kpi-value" id="totalSales">$0</div>
                <div class="kpi-sub" id="totalSalesCompare">Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø¯ÙˆØ±Ù‡ Ù‚Ø¨Ù„</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø³Ø§ÙØ±Ø§Ù†</span>
                    <div class="kpi-icon"><i class="fas fa-users"></i></div>
                </div>
                <div class="kpi-value" id="totalPassengers">0</div>
                <div class="kpi-sub" id="totalPassengersCompare">Ù†ÙØ±</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‡Ø± ØªÙˆØ±</span>
                    <div class="kpi-icon"><i class="fas fa-chart-line"></i></div>
                </div>
                <div class="kpi-value" id="avgPerTour">$0</div>
                <div class="kpi-sub" id="totalTransactions">Û° ØªØ±Ø§Ú©Ù†Ø´</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Ù¾ÙˆØ±Ø³Ø§Ù†Øª</span>
                    <div class="kpi-icon"><i class="fas fa-percent"></i></div>
                </div>
                <div class="kpi-value" id="commission">$0</div>
                <div class="kpi-sub">Û±Û°Ùª Ø§Ø² ÙØ±ÙˆØ´</div>
            </div>
        </div>

        <!-- Ø¬Ø¯Ø§ÙˆÙ„ ØªØ­Ù„ÛŒÙ„ÛŒ -->
        <div class="tables-grid">
            <!-- Top Agents -->
            <div class="table-card">
                <div class="table-header">
                    <span class="table-title">
                        <i class="fas fa-user-tie" style="margin-left: 8px;"></i>
                        Ø¨Ø±ØªØ±ÛŒÙ† Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡â€ŒÙ‡Ø§
                    </span>
                    <span class="badge badge-agent">Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±ÙˆØ´</span>
                </div>
                <div class="table-container">
                    <table id="agentsTable">
                        <thead>
                            <tr>
                                <th>Ø±ØªØ¨Ù‡</th>
                                <th>Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</th>
                                <th>ÙØ±ÙˆØ´</th>
                                <th>Ù¾ÙˆØ±Ø³Ø§Ù†Øª</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                            <tr><td colspan="4" class="loading-row">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top OTAs -->
            <div class="table-card">
                <div class="table-header">
                    <span class="table-title">
                        <i class="fas fa-globe" style="margin-left: 8px;"></i>
                        Ø¨Ø±ØªØ±ÛŒÙ† OTAÙ‡Ø§
                    </span>
                    <span class="badge badge-ota">Ø®Ø§Ù„Øµ Ù¾Ø³ Ø§Ø² Ú©Ù…ÛŒØ³ÛŒÙˆÙ†</span>
                </div>
                <div class="table-container">
                    <table id="otasTable">
                        <thead>
                            <tr>
                                <th>Ø±ØªØ¨Ù‡</th>
                                <th>OTA</th>
                                <th>ÙØ±ÙˆØ´ Ù†Ø§Ø®Ø§Ù„Øµ</th>
                                <th>ÙØ±ÙˆØ´ Ø®Ø§Ù„Øµ</th>
                                <th>Ø³Ù‡Ù…</th>
                            </tr>
                        </thead>
                        <tbody id="otasTableBody">
                            <tr><td colspan="5" class="loading-row">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Tours -->
            <div class="table-card">
                <div class="table-header">
                    <span class="table-title">
                        <i class="fas fa-umbrella-beach" style="margin-left: 8px;"></i>
                        Ù¾Ø±ÙØ±ÙˆØ´â€ŒØªØ±ÛŒÙ† ØªÙˆØ±Ù‡Ø§
                    </span>
                    <span class="badge badge-direct">Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ†</span>
                </div>
                <div class="table-container">
                    <table id="toursTable">
                        <thead>
                            <tr>
                                <th>Ø±ØªØ¨Ù‡</th>
                                <th>Ù†Ø§Ù… ØªÙˆØ±</th>
                                <th>Ø±Ø²Ø±Ùˆ</th>
                                <th>ÙØ±ÙˆØ´</th>
                                <th>Ú©Ø§Ù†Ø§Ù„ Ø§ØµÙ„ÛŒ</th>
                            </tr>
                        </thead>
                        <tbody id="toursTableBody">
                            <tr><td colspan="5" class="loading-row">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBbxZctdClpD2d8GgRw2DcSrLx7hPXVcH4",
            authDomain: "tourbin-dashboard.firebaseapp.com",
            projectId: "tourbin-dashboard",
            storageBucket: "tourbin-dashboard.appspot.com",
            messagingSenderId: "1033548972731",
            appId: "1:1033548972731:web:5e6a6d6f8d8b8a8b8c8d8e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
        let currentStartDate = new Date();
        let currentEndDate = new Date();
        let allTransactions = [];

        // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ)
        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = formatDate(firstDay);
            document.getElementById('endDate').value = formatDate(lastDay);
            
            currentStartDate = firstDay;
            currentEndDate = lastDay;
        }

        // ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ (Ø¨Ø±Ø§ÛŒ Flatpickr)
        function toGregorian(dateStr) {
            if (!dateStr) return new Date();
            // Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ Ø§Ø² Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
            // ÙØ¹Ù„Ø§Ù‹ Ø³Ø§Ø¯Ù‡ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ÛŒ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ù‡Ø³Øª
            return new Date(dateStr);
        }

        // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø§ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§
        window.setDateRange = function(range) {
            const today = new Date();
            let start = new Date();
            let end = new Date();

            switch(range) {
                case 'today':
                    start = today;
                    end = today;
                    break;
                case '7days':
                    start = new Date(today.setDate(today.getDate() - 7));
                    end = new Date();
                    break;
                case '30days':
                    start = new Date(today.setDate(today.getDate() - 30));
                    end = new Date();
                    break;
                case 'thisMonth':
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    end = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
            }

            document.getElementById('startDate').value = formatDate(start);
            document.getElementById('endDate').value = formatDate(end);
            
            currentStartDate = start;
            currentEndDate = end;
            
            loadData();
        };

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Flatpickr
        flatpickr("#startDate", {
            locale: "fa",
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr) {
                currentStartDate = selectedDates[0];
            }
        });

        flatpickr("#endDate", {
            locale: "fa",
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr) {
                currentEndDate = selectedDates[0];
            }
        });

        // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù„ÙˆØ¯ Ø¯ÛŒØªØ§
        window.loadData = async function() {
            try {
                console.log('Ø´Ø±ÙˆØ¹ Ù„ÙˆØ¯ Ø¯ÛŒØªØ§...');
                
                // Ø´Ùˆ Ù„ÙˆØ¯ÛŒÙ†Ú¯
                showLoading();

                // Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø§Ø² Firestore
                const transactions = await fetchTransactions();
                allTransactions = transactions;
                
                // ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®
                const filteredTransactions = filterByDate(transactions);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ KPI
                updateKPIs(filteredTransactions);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯Ø§ÙˆÙ„
                updateAgentsTable(filteredTransactions);
                updateOTAsTable(filteredTransactions);
                updateToursTable(filteredTransactions);
                
                console.log('Ø¯ÛŒØªØ§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ÙˆØ¯ Ø´Ø¯:', filteredTransactions.length, 'ØªØ±Ø§Ú©Ù†Ø´');
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ Ø¯ÛŒØªØ§:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ' + error.message);
            }
        };

        // Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø§Ø² Firestore
        async function fetchTransactions() {
            try {
                const snapshot = await db.collection('sales_transactions')
                    .where('status', 'in', ['CONFIRMED', 'ARRIVED'])
                    .get();
                
                const transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return transactions;
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Firestore:', error);
                return [];
            }
        }

        // ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®
        function filterByDate(transactions) {
            if (!currentStartDate || !currentEndDate) return transactions;
            
            const start = new Date(currentStartDate);
            start.setHours(0, 0, 0, 0);
            
            const end = new Date(currentEndDate);
            end.setHours(23, 59, 59, 999);
            
            return transactions.filter(t => {
                if (!t.creation_date) return false;
                
                const tDate = t.creation_date.toDate ? 
                    t.creation_date.toDate() : 
                    new Date(t.creation_date);
                
                return tDate >= start && tDate <= end;
            });
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ KPIÙ‡Ø§
        function updateKPIs(transactions) {
            // ÙØ±ÙˆØ´ Ú©Ù„
            const totalSales = transactions.reduce((sum, t) => sum + (t.total_price_usd || 0), 0);
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            
            // ØªØ¹Ø¯Ø§Ø¯ Ù…Ø³Ø§ÙØ±Ø§Ù†
            const totalPassengers = transactions.reduce((sum, t) => sum + (t.total_pax || 0), 0);
            document.getElementById('totalPassengers').textContent = totalPassengers.toLocaleString();
            
            // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‡Ø± ØªÙˆØ±
            const avgPerTour = transactions.length > 0 ? totalSales / transactions.length : 0;
            document.getElementById('avgPerTour').textContent = formatCurrency(avgPerTour);
            document.getElementById('totalTransactions').textContent = transactions.length + ' ØªØ±Ø§Ú©Ù†Ø´';
            
            // Ù¾ÙˆØ±Ø³Ø§Ù†Øª (Û±Û°Ùª)
            const commission = totalSales * 0.1;
            document.getElementById('commission').textContent = formatCurrency(commission);
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡â€ŒÙ‡Ø§
        function updateAgentsTable(transactions) {
            const agentSales = {};
            
            transactions.forEach(t => {
                const agent = t.agent_name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                if (!agentSales[agent]) {
                    agentSales[agent] = {
                        sales: 0,
                        count: 0
                    };
                }
                agentSales[agent].sales += t.total_price_usd || 0;
                agentSales[agent].count++;
            });
            
            const sortedAgents = Object.entries(agentSales)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);
            
            const tbody = document.getElementById('agentsTableBody');
            tbody.innerHTML = '';
            
            sortedAgents.forEach((agent, index) => {
                const row = document.createElement('tr');
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                
                row.innerHTML = `
                    <td class="rank ${rankClass}">${getRankEmoji(index)}</td>
                    <td>${agent.name}</td>
                    <td>${formatCurrency(agent.sales)}</td>
                    <td>${formatCurrency(agent.sales * 0.1)}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (sortedAgents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
            }
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„ OTAÙ‡Ø§
        function updateOTAsTable(transactions) {
            const otaCommission = {
                'OTA_GetYourGuide': 0.3,
                'OTA_Viator': 0.25
            };
            const defaultCommission = 0.25;
            
            const otaSales = {};
            let totalOTASales = 0;
            
            transactions.forEach(t => {
                if (t.channel && t.channel.startsWith('OTA_')) {
                    if (!otaSales[t.channel]) {
                        otaSales[t.channel] = {
                            gross: 0,
                            count: 0
                        };
                    }
                    otaSales[t.channel].gross += t.total_price_usd || 0;
                    otaSales[t.channel].count++;
                    totalOTASales += t.total_price_usd || 0;
                }
            });
            
            const sortedOTAs = Object.entries(otaSales)
                .map(([name, data]) => {
                    const commission = otaCommission[name] || defaultCommission;
                    return {
                        name: name.replace('OTA_', ''),
                        gross: data.gross,
                        net: data.gross * (1 - commission),
                        count: data.count,
                        share: totalOTASales > 0 ? (data.gross / totalOTASales) * 100 : 0
                    };
                })
                .sort((a, b) => b.gross - a.gross);
            
            const tbody = document.getElementById('otasTableBody');
            tbody.innerHTML = '';
            
            sortedOTAs.forEach((ota, index) => {
                const row = document.createElement('tr');
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                
                row.innerHTML = `
                    <td class="rank ${rankClass}">${getRankEmoji(index)}</td>
                    <td>${ota.name}</td>
                    <td>${formatCurrency(ota.gross)}</td>
                    <td>${formatCurrency(ota.net)}</td>
                    <td>${ota.share.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
            
            if (sortedOTAs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
            }
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„ ØªÙˆØ±Ù‡Ø§
        function updateToursTable(transactions) {
            const tourSales = {};
            
            transactions.forEach(t => {
                const tour = t.product_title || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                if (!tourSales[tour]) {
                    tourSales[tour] = {
                        revenue: 0,
                        bookings: 0,
                        channels: {}
                    };
                }
                tourSales[tour].revenue += t.total_price_usd || 0;
                tourSales[tour].bookings++;
                if (t.channel) {
                    tourSales[tour].channels[t.channel] = (tourSales[tour].channels[t.channel] || 0) + 1;
                }
            });
            
            const sortedTours = Object.entries(tourSales)
                .map(([name, data]) => {
                    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†Ø§Ù„ Ø§ØµÙ„ÛŒ
                    let mainChannel = 'OTA';
                    let maxCount = 0;
                    for (const [channel, count] of Object.entries(data.channels)) {
                        if (count > maxCount) {
                            maxCount = count;
                            mainChannel = channel;
                        }
                    }
                    
                    return {
                        name: name.length > 30 ? name.substring(0, 30) + '...' : name,
                        revenue: data.revenue,
                        bookings: data.bookings,
                        mainChannel: mainChannel.replace('OTA_', '')
                    };
                })
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);
            
            const tbody = document.getElementById('toursTableBody');
            tbody.innerHTML = '';
            
            sortedTours.forEach((tour, index) => {
                const row = document.createElement('tr');
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                
                row.innerHTML = `
                    <td class="rank ${rankClass}">${getRankEmoji(index)}</td>
                    <td>${tour.name}</td>
                    <td>${tour.bookings}</td>
                    <td>${formatCurrency(tour.revenue)}</td>
                    <td><span class="badge badge-ota">${tour.mainChannel}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            if (sortedTours.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
            }
        }

        // Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø±ØªØ¨Ù‡
        function getRankEmoji(index) {
            switch(index) {
                case 0: return 'ğŸ¥‡';
                case 1: return 'ğŸ¥ˆ';
                case 2: return 'ğŸ¥‰';
                default: return (index + 1) + '';
            }
        }

        // ÙØ±Ù…Øª Ø§Ø±Ø²
        function formatCurrency(value) {
            return '$' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯
        function showLoading() {
            const loadingHTML = '<tr><td colspan="4" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>';
            document.getElementById('agentsTableBody').innerHTML = loadingHTML;
            document.getElementById('otasTableBody').innerHTML = loadingHTML.replace('4', '5');
            document.getElementById('toursTableBody').innerHTML = loadingHTML.replace('4', '5');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
        function showError(message) {
            // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù„Ù…Ø§Ù† Ø®Ø·Ø§ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù‡
            let errorDiv = document.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.cssText = 'background: #ffebee; color: #c62828; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;';
                document.querySelector('.date-section').after(errorDiv);
            }
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            
            // Ø¨Ø¹Ø¯ Ø§Ø² Ûµ Ø«Ø§Ù†ÛŒÙ‡ Ù¾Ø§Ú©Ø´ Ú©Ù†
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDates();
            loadData();
        });
    </script>
</body>
</html>
